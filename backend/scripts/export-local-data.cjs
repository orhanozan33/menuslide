/**
 * Yerel PostgreSQL'den veriyi INSERT'ler halinde dışa aktarır.
 * Kullanım: BACKEND klasöründen: node scripts/export-local-data.cjs
 * Bağlantı: .env veya localhost:5432, db tvproje, user postgres, password 333333
 */
const { Client } = require('pg');
const fs = require('fs');
const path = require('path');

// Sıra: FK nedeniyle templates/template_blocks, screens'den önce olmalı
const TABLES = [
  'businesses',
  'users',
  'menus',
  'menu_items',
  'languages',
  'menu_item_translations',
  'plans',
  'subscriptions',
  'payments',
  'templates',
  'template_blocks',
  'screens',
  'screen_menu',
  'menu_schedules',
  'screen_blocks',
  'template_block_contents',
  'screen_block_contents',
  'content_library',
  'content_library_categories',
  'contact_info',
  'home_channels',
  'screen_template_rotations',
  'display_viewers',
  'payment_failures',
  'admin_permissions',
  'admin_activity_log',
  'screen_edit_history',
];

function escape(val) {
  if (val === null) return 'NULL';
  if (typeof val === 'boolean') return val ? 'true' : 'false';
  if (val instanceof Date) return "'" + val.toISOString().replace(/T/, ' ').replace(/\.\d{3}Z$/, '+00') + "'";
  if (typeof val === 'number') return String(val);
  // JSON: sadece tek tırnak kaçır (backslash kaçırma; \" JSON'da geçerli kalmalı)
  if (typeof val === 'object') return "'" + JSON.stringify(val).replace(/'/g, "''") + "'";
  return "'" + escapeString(String(val)) + "'";
}

function escapeString(s) {
  return s.replace(/'/g, "''").replace(/\\/g, '\\\\');
}

async function main() {
  const client = new Client({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432', 10),
    database: process.env.DB_NAME || 'tvproje',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || '333333',
  });

  const outPath = path.join(__dirname, '../../database/export-from-local-data.sql');
  const lines = [
    '-- Export from local PostgreSQL for Supabase import',
    '-- Run this in Supabase SQL Editor',
    '-- Generated by backend/scripts/export-local-data.cjs',
    '',
  ];

  try {
    await client.connect();
    console.log('Connected to local DB');

    let screenIds = null;
    for (const table of TABLES) {
      try {
        let res = await client.query(`SELECT * FROM ${table}`);
        if (table === 'display_viewers' && res.rows.length > 0) {
          if (!screenIds) {
            const screenRes = await client.query('SELECT id FROM screens');
            screenIds = new Set(screenRes.rows.map((r) => r.id));
          }
          res = { ...res, rows: res.rows.filter((r) => r.screen_id && screenIds.has(r.screen_id)) };
          if (res.rows.length === 0) {
            console.log(`  ${table}: 0 rows (skip, screen_id referansları screens'te yok)`);
            continue;
          }
        }
        if (res.rows.length === 0) {
          console.log(`  ${table}: 0 rows (skip)`);
          continue;
        }
        const cols = res.fields.map((f) => f.name);
        const colList = cols.join(', ');
        lines.push(`-- ${table} (${res.rows.length} rows)`);
        const hasId = cols.includes('id');
        const hasEmail = cols.includes('email');
        const hasCode = cols.includes('code');
        const hasName = cols.includes('name');
        let conflictClause = '';
        if (table === 'users' && hasEmail) {
          conflictClause = ' ON CONFLICT (email) DO NOTHING';
        } else if (table === 'languages' && hasCode) {
          conflictClause = ' ON CONFLICT (code) DO NOTHING';
        } else if (table === 'plans' && hasName) {
          conflictClause = ' ON CONFLICT (name) DO NOTHING';
        } else if (hasId) {
          conflictClause = ' ON CONFLICT (id) DO NOTHING';
        }
        for (const row of res.rows) {
          const vals = cols.map((c) => escape(row[c]));
          lines.push(`INSERT INTO ${table} (${colList}) VALUES (${vals.join(', ')})${conflictClause};`);
        }
        lines.push('');
        console.log(`  ${table}: ${res.rows.length} rows`);
      } catch (e) {
        if (e.code === '42P01') {
          console.log(`  ${table}: table does not exist (skip)`);
        } else {
          console.error(`  ${table}:`, e.message);
        }
      }
    }

    fs.writeFileSync(outPath, lines.join('\n'), 'utf8');
    console.log('\nWritten:', outPath);
  } finally {
    await client.end();
  }
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
